const SS = SpreadsheetApp.getActiveSpreadsheet();

const SHEETS = {
  vehicles: 'vehicles',
  repairs: 'repairs',
  fuel: 'fuel',
  accidents: 'accidents',
  documents: 'documents',
  insurances: 'insurances',
  inspectionCerts: 'inspectionCerts'
};

function doGet(e) {
  try {
    const action = e.parameter.action;
    const callback = e.parameter.callback;
    const sheet = e.parameter.sheet;
    
    let result;
    
    // データ取得
    if (action === 'getAllSheets') {
      const allData = {};
      Object.keys(SHEETS).forEach(key => {
        allData[key] = getAllData(SHEETS[key]);
      });
      result = { success: true, data: allData };
    }
    
    // データ追加・更新・削除（GETパラメータで処理）
    else if (action === 'add' || action === 'update') {
      const dataJson = e.parameter.data;
      if (dataJson) {
        const data = JSON.parse(decodeURIComponent(dataJson));
        if (action === 'add') {
          addData(sheet, data);
        } else {
          updateData(sheet, data);
        }
        result = { success: true };
      } else {
        result = { success: false, error: 'No data provided' };
      }
    }
    
    else if (action === 'delete') {
      const id = e.parameter.id;
      if (id) {
        deleteData(sheet, id);
        result = { success: true };
      } else {
        result = { success: false, error: 'No ID provided' };
      }
    }
    
    else {
      result = { success: false, error: 'Invalid action' };
    }
    
    // JSONP対応
    if (callback) {
      return ContentService
        .createTextOutput(callback + '(' + JSON.stringify(result) + ')')
        .setMimeType(ContentService.MimeType.JAVASCRIPT);
    }
    
    return ContentService
      .createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    const errorResult = { success: false, error: error.toString() };
    const callback = e.parameter.callback;
    
    if (callback) {
      return ContentService
        .createTextOutput(callback + '(' + JSON.stringify(errorResult) + ')')
        .setMimeType(ContentService.MimeType.JAVASCRIPT);
    }
    
    return ContentService
      .createTextOutput(JSON.stringify(errorResult))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doPost(e) {
  try {
    const params = JSON.parse(e.postData.contents);
    const action = params.action;
    const sheet = params.sheet;
    const data = params.data;
    
    if (action === 'add') {
      addData(sheet, data);
      return createResponse({ success: true });
    }
    
    if (action === 'update') {
      updateData(sheet, data);
      return createResponse({ success: true });
    }
    
    if (action === 'delete') {
      deleteData(sheet, params.id);
      return createResponse({ success: true });
    }
    
    return createResponse({ success: false, error: 'Invalid action' });
  } catch (error) {
    return createResponse({ success: false, error: error.toString() });
  }
}

function getAllData(sheetName) {
  const sheet = SS.getSheetByName(sheetName);
  if (!sheet) return [];
  
  const data = sheet.getDataRange().getValues();
  if (data.length <= 1) return [];
  
  const headers = data[0];
  const rows = data.slice(1);
  
  return rows.map(row => {
    const obj = {};
    headers.forEach((header, index) => {
      obj[header] = row[index];
    });
    return obj;
  });
}

function addData(sheetName, data) {
  const sheet = SS.getSheetByName(sheetName);
  if (!sheet) throw new Error('Sheet not found: ' + sheetName);
  
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const row = headers.map(header => data[header] || '');
  
  sheet.appendRow(row);
}

function updateData(sheetName, data) {
  const sheet = SS.getSheetByName(sheetName);
  if (!sheet) throw new Error('Sheet not found: ' + sheetName);
  
  const allData = sheet.getDataRange().getValues();
  const headers = allData[0];
  const idIndex = headers.indexOf('id');
  
  if (idIndex === -1) throw new Error('ID column not found');
  
  for (let i = 1; i < allData.length; i++) {
    if (allData[i][idIndex] === data.id) {
      const row = headers.map(header => data[header] || allData[i][headers.indexOf(header)]);
      sheet.getRange(i + 1, 1, 1, headers.length).setValues([row]);
      return;
    }
  }
  
  addData(sheetName, data);
}

function deleteData(sheetName, id) {
  const sheet = SS.getSheetByName(sheetName);
  if (!sheet) throw new Error('Sheet not found: ' + sheetName);
  
  const allData = sheet.getDataRange().getValues();
  const headers = allData[0];
  const idIndex = headers.indexOf('id');
  
  if (idIndex === -1) throw new Error('ID column not found');
  
  for (let i = 1; i < allData.length; i++) {
    if (allData[i][idIndex] === id) {
      sheet.deleteRow(i + 1);
      return;
    }
  }
}

function createResponse(data) {
  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}
